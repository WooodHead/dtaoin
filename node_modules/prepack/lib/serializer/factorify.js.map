{"version":3,"sources":["../../src/serializer/factorify.js"],"names":["factorifyObjects","t","isSameNode","left","right","type","name","value","getObjectKeys","obj","keys","properties","prop","key","push","computed","indexOf","join","body","factoryNameGenerator","signatures","Object","create","node","declarations","declar","init","declars","signatureKey","length","split","rootFactoryParams","rootFactoryProps","keyIndex","id","identifier","keyNode","isValidIdentifier","stringLiteral","objectProperty","rootFactoryId","generate","rootFactoryBody","blockStatement","returnStatement","objectExpression","rootFactory","functionDeclaration","unshift","args","callExpression","seen","Set","has","common","Map","mostSharedArgsLength","declar2","sharedArgs","i","arguments","Math","max","set","sharedPairs","entries","pair","highestPairArgs","highestPairCount","pairArgs","declarsSub","concat","removeArgs","subFactoryArgs","subFactoryParams","arg","subFactoryId","subFactoryBody","subFactory","declarSub","add","call","callee","filter","val"],"mappings":"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","file":"factorify.js","sourcesContent":["/**\n * Copyright (c) 2017-present, Facebook, Inc.\n * All rights reserved.\n *\n * This source code is licensed under the BSD-style license found in the\n * LICENSE file in the root directory of this source tree. An additional grant\n * of patent rights can be found in the PATENTS file in the same directory.\n */\n\n/* @flow */\n\nimport * as t from \"babel-types\";\nimport type { BabelNodeStatement, BabelNodeObjectExpression, BabelNodeLVal } from \"babel-types\";\nimport { NameGenerator } from \"../utils/generator.js\";\n\nfunction isSameNode(left, right) {\n  let type = left.type;\n\n  if (type !== right.type) {\n    return false;\n  }\n\n  if (type === \"Identifier\") {\n    return left.name === right.name;\n  }\n\n  if (type === \"NullLiteral\") {\n    return true;\n  }\n\n  if (type === \"BooleanLiteral\" || type === \"StringLiteral\" || type === \"NumericLiteral\") {\n    return left.value === right.value;\n  }\n\n  return false;\n}\n\nfunction getObjectKeys(obj: BabelNodeObjectExpression): string | false {\n  let keys = [];\n\n  for (let prop of obj.properties) {\n    if (prop.type !== \"ObjectProperty\") return false;\n\n    let key = prop.key;\n    if (key.type === \"StringLiteral\") {\n      keys.push(key.value);\n    } else if (key.type === \"Identifier\") {\n      if (prop.computed) return false;\n      keys.push(key.name);\n    } else {\n      return false;\n    }\n  }\n\n  for (let key of keys) {\n    if (key.indexOf(\"|\") >= 0) return false;\n  }\n\n  return keys.join(\"|\");\n}\n\n// This function looks for recurring initialization patterns in the code of the form\n//   var x = { a: literal1, b: literal2 }\n//   var y = { a: literal1, b: literal3 }\n// and transforms them into something like\n//   function factory(b) { return { a: literal1, b } }\n//   var x = factory(literal2);\n//   var y = factory(literal3);\n// TODO #884: Right now, the visitor below only looks into top-level variable declaration\n// with a flat object literal initializer.\n// It should also look into conditional control flow, residual functions, and nested object literals.\nexport function factorifyObjects(body: Array<BabelNodeStatement>, factoryNameGenerator: NameGenerator) {\n  let signatures = Object.create(null);\n\n  for (let node of body) {\n    if (node.type !== \"VariableDeclaration\") continue;\n\n    for (let declar of node.declarations) {\n      let { init } = declar;\n      if (!init) continue;\n      if (init.type !== \"ObjectExpression\") continue;\n\n      let keys = getObjectKeys(init);\n      if (!keys) continue;\n\n      let declars = (signatures[keys] = signatures[keys] || []);\n      declars.push(declar);\n    }\n  }\n\n  for (let signatureKey in signatures) {\n    let declars = signatures[signatureKey];\n    if (declars.length < 5) continue;\n\n    let keys = signatureKey.split(\"|\");\n\n    //\n    let rootFactoryParams: Array<BabelNodeLVal> = [];\n    let rootFactoryProps = [];\n    for (let keyIndex = 0; keyIndex < keys.length; keyIndex++) {\n      let key = keys[keyIndex];\n      let id = t.identifier(`__${keyIndex}`);\n      rootFactoryParams.push(id);\n      let keyNode = t.isValidIdentifier(key) ? t.identifier(key) : t.stringLiteral(key);\n      rootFactoryProps.push(t.objectProperty(keyNode, id));\n    }\n\n    let rootFactoryId = t.identifier(factoryNameGenerator.generate(\"root\"));\n    let rootFactoryBody = t.blockStatement([t.returnStatement(t.objectExpression(rootFactoryProps))]);\n    let rootFactory = t.functionDeclaration(rootFactoryId, rootFactoryParams, rootFactoryBody);\n    body.unshift(rootFactory);\n\n    //\n    for (let declar of declars) {\n      let args = [];\n      for (let prop of declar.init.properties) {\n        args.push(prop.value);\n      }\n\n      declar.init = t.callExpression(rootFactoryId, args);\n    }\n\n    //\n    let seen = new Set();\n    for (let declar of declars) {\n      if (seen.has(declar)) continue;\n\n      // build up a map containing the arguments that are shared\n      let common = new Map();\n      let mostSharedArgsLength = 0;\n      for (let declar2 of declars) {\n        if (seen.has(declar2)) continue;\n        if (declar === declar2) continue;\n\n        let sharedArgs = [];\n        for (let i = 0; i < keys.length; i++) {\n          if (isSameNode(declar.init.arguments[i], declar2.init.arguments[i])) {\n            sharedArgs.push(i);\n          }\n        }\n        if (!sharedArgs.length) continue;\n\n        mostSharedArgsLength = Math.max(mostSharedArgsLength, sharedArgs.length);\n        common.set(declar2, sharedArgs);\n      }\n\n      // build up a mapping of the argument positions that are shared so we can pick the top one\n      let sharedPairs = Object.create(null);\n      for (let [declar2, args] of common.entries()) {\n        if (args.length === mostSharedArgsLength) {\n          args = args.join(\",\");\n          let pair = (sharedPairs[args] = sharedPairs[args] || []);\n          pair.push(declar2);\n        }\n      }\n\n      // get the highest pair\n      let highestPairArgs;\n      let highestPairCount;\n      for (let pairArgs in sharedPairs) {\n        let pair = sharedPairs[pairArgs];\n        if (!highestPairArgs || pair.length > highestPairCount) {\n          highestPairCount = pair.length;\n          highestPairArgs = pairArgs;\n        }\n      }\n      if (!highestPairArgs) continue;\n\n      //\n      let declarsSub = sharedPairs[highestPairArgs].concat(declar);\n      let removeArgs = highestPairArgs.split(\",\");\n\n      let subFactoryArgs = [];\n      let subFactoryParams = [];\n      let sharedArgs = declarsSub[0].init.arguments;\n      for (let i = 0; i < sharedArgs.length; i++) {\n        let arg = sharedArgs[i];\n        if (removeArgs.indexOf(i + \"\") >= 0) {\n          subFactoryArgs.push(arg);\n        } else {\n          let id = t.identifier(`__${i}`);\n          subFactoryArgs.push(id);\n          subFactoryParams.push(id);\n        }\n      }\n\n      let subFactoryId = t.identifier(factoryNameGenerator.generate(\"sub\"));\n      let subFactoryBody = t.blockStatement([t.returnStatement(t.callExpression(rootFactoryId, subFactoryArgs))]);\n      let subFactory = t.functionDeclaration(subFactoryId, subFactoryParams, subFactoryBody);\n      body.unshift(subFactory);\n\n      for (let declarSub of declarsSub) {\n        seen.add(declarSub);\n\n        let call = declarSub.init;\n        call.callee = subFactoryId;\n        call.arguments = call.arguments.filter(function(val, i) {\n          return removeArgs.indexOf(i + \"\") < 0;\n        });\n      }\n    }\n  }\n}\n"]}