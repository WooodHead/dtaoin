{"version":3,"sources":["../../../src/intrinsics/ecma262/Math.js"],"names":["realm","obj","intrinsics","ObjectPrototype","defineNativeProperty","SymbolToStringTag","writable","defineNativeConstant","functions","isCompatibleWith","MOBILE_JSC_VERSION","push","name","length","defineNativeMethod","context","args","originalLength","some","arg","every","r","buildMathTemplates","get","undefined","names","Array","map","_","i","f","join","set","createAbstract","topVal","mapping","nodes","preludeGenerator","Math","apply","throwIfNotConcrete","x","y","a","b","buildMathImul","A","B","imul","mathRandomGenerator","useAbstractInterpretation","deriveAbstract","buildMathRandom","isPure","skipInvariant","random","Map"],"mappings":"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","file":"Math.js","sourcesContent":["/**\n * Copyright (c) 2017-present, Facebook, Inc.\n * All rights reserved.\n *\n * This source code is licensed under the BSD-style license found in the\n * LICENSE file in the root directory of this source tree. An additional grant\n * of patent rights can be found in the PATENTS file in the same directory.\n */\n\n/* @flow */\n\nimport type { Realm } from \"../../realm.js\";\nimport { StringValue, ObjectValue, NumberValue, AbstractValue } from \"../../values/index.js\";\nimport { ToNumber, ToUint32, IsToNumberPure } from \"../../methods/index.js\";\nimport { TypesDomain, ValuesDomain } from \"../../domains/index.js\";\nimport invariant from \"../../invariant.js\";\nimport buildExpressionTemplate from \"../../utils/builder.js\";\n\nlet buildMathRandom = buildExpressionTemplate(\"global.Math.random()\");\nlet buildMathImul = buildExpressionTemplate(\"global.Math.imul(A, B)\");\nlet buildMathTemplates: Map<string, { f: Function, names: Array<string> }> = new Map();\n\nexport default function(realm: Realm): ObjectValue {\n  let obj = new ObjectValue(realm, realm.intrinsics.ObjectPrototype, \"Math\");\n\n  // ECMA262 20.2.1.9\n  obj.defineNativeProperty(realm.intrinsics.SymbolToStringTag, new StringValue(realm, \"Math\"), { writable: false });\n\n  // ECMA262 20.2.1.1\n  obj.defineNativeConstant(\"E\", new NumberValue(realm, 2.7182818284590452354));\n\n  // ECMA262 20.2.1.2\n  obj.defineNativeConstant(\"LN10\", new NumberValue(realm, 2.302585092994046));\n\n  // ECMA262 20.2.1.3\n  obj.defineNativeConstant(\"LN2\", new NumberValue(realm, 0.6931471805599453));\n\n  // ECMA262 20.2.1.4\n  obj.defineNativeConstant(\"LOG10E\", new NumberValue(realm, 0.4342944819032518));\n\n  // ECMA262 20.2.1.5\n  obj.defineNativeConstant(\"LOG2E\", new NumberValue(realm, 1.4426950408889634));\n\n  // ECMA262 20.2.1.6\n  obj.defineNativeConstant(\"PI\", new NumberValue(realm, 3.1415926535897932));\n\n  // ECMA262 20.2.1.7\n  obj.defineNativeConstant(\"SQRT1_2\", new NumberValue(realm, 0.7071067811865476));\n\n  // ECMA262 20.2.1.8\n  obj.defineNativeConstant(\"SQRT2\", new NumberValue(realm, 1.4142135623730951));\n\n  let functions = [\n    // ECMA262 20.2.2.1\n    [\"abs\", 1],\n\n    // ECMA262 20.2.2.2\n    [\"acos\", 1],\n\n    // ECMA262 20.2.2.3\n    [\"acosh\", 1],\n\n    // ECMA262 20.2.2.4\n    [\"asin\", 1],\n\n    // ECMA262 20.2.2.5\n    [\"asinh\", 1],\n\n    // ECMA262 20.2.2.6\n    [\"atan\", 1],\n\n    // ECMA262 20.2.2.7\n    [\"atanh\", 1],\n\n    // ECMA262 20.2.2.8\n    [\"atan2\", 2],\n\n    // ECMA262 20.2.2.9\n    [\"cbrt\", 1],\n\n    // ECMA262 20.2.2.10\n    [\"ceil\", 1],\n\n    // ECMA262 20.2.2.12\n    [\"cos\", 1],\n\n    // ECMA262 20.2.2.13\n    [\"cosh\", 1],\n\n    // ECMA262 20.2.2.14\n    [\"exp\", 1],\n\n    // ECMA262 20.2.2.15\n    [\"expm1\", 1],\n\n    // ECMA262 20.2.2.16\n    [\"floor\", 1],\n\n    // ECMA262 20.2.2.17\n    [\"fround\", 1],\n\n    // ECMA262 20.2.2.18\n    [\"hypot\", 2],\n\n    // ECMA262 20.2.2.20\n    [\"log\", 1],\n\n    // ECMA262 20.2.2.21\n    [\"log1p\", 1],\n\n    // ECMA262 20.2.2.22\n    [\"log10\", 1],\n\n    // ECMA262 20.2.2.23\n    [\"log2\", 1],\n\n    // ECMA262 20.2.2.24 ( _value1_, _value2_, ..._values_ )\n    [\"max\", 2],\n\n    // ECMA262 20.2.2.25\n    [\"min\", 2],\n\n    // ECMA262 20.2.2.26\n    [\"pow\", 2],\n\n    // ECMA262 20.2.2.28\n    [\"round\", 1],\n\n    // ECMA262 20.2.2.30\n    [\"sin\", 1],\n\n    // ECMA262 20.2.2.31\n    [\"sinh\", 1],\n\n    // ECMA262 20.2.2.32\n    [\"sqrt\", 1],\n\n    // ECMA262 20.2.2.33\n    [\"tan\", 1],\n\n    // ECMA262 20.2.2.34\n    [\"tanh\", 1],\n\n    // ECMA262 20.2.2.35\n    [\"trunc\", 1],\n  ];\n\n  // ECMA262 20.2.2.11\n  if (!realm.isCompatibleWith(realm.MOBILE_JSC_VERSION)) functions.push([\"clz32\", 1]);\n\n  // ECMA262 20.2.2.29 (_x_)\n  if (!realm.isCompatibleWith(realm.MOBILE_JSC_VERSION)) functions.push([\"sign\", 1]);\n\n  for (let [name, length] of functions) {\n    obj.defineNativeMethod(name, length, (context, args, originalLength) => {\n      args.length = originalLength;\n      if (args.some(arg => arg instanceof AbstractValue) && args.every(arg => IsToNumberPure(realm, arg))) {\n        let r = buildMathTemplates.get(name);\n        if (r === undefined) {\n          let names = [...new Array(args.length)].map((_, i) => `X${i}`);\n          let f = buildExpressionTemplate(`Math.${name}(${names.join(\", \")})`);\n          buildMathTemplates.set(name, (r = { f, names }));\n        }\n\n        return realm.createAbstract(new TypesDomain(NumberValue), ValuesDomain.topVal, args, nodes => {\n          invariant(r !== undefined);\n          let mapping = {};\n          for (let i = 0; i < nodes.length; i++) mapping[r.names[i]] = nodes[i];\n          return r.f(realm.preludeGenerator)(mapping);\n        });\n      }\n\n      return new NumberValue(\n        realm,\n        Math[name].apply(null, args.map((arg, i) => ToNumber(realm, arg.throwIfNotConcrete())))\n      );\n    });\n  }\n\n  // ECMA262 20.2.2.19\n  obj.defineNativeMethod(\"imul\", 2, (context, [x, y]) => {\n    if (\n      (x instanceof AbstractValue || y instanceof AbstractValue) &&\n      IsToNumberPure(realm, x) &&\n      IsToNumberPure(realm, y)\n    ) {\n      return realm.createAbstract(new TypesDomain(NumberValue), ValuesDomain.topVal, [x, y], ([a, b]) =>\n        buildMathImul(realm.preludeGenerator)({ A: a, B: b })\n      );\n    }\n\n    return new NumberValue(\n      realm,\n      Math.imul(ToUint32(realm, x.throwIfNotConcrete()), ToUint32(realm, y.throwIfNotConcrete()))\n    );\n  });\n\n  // ECMA262 20.2.2.27\n  obj.defineNativeMethod(\"random\", 0, context => {\n    if (realm.mathRandomGenerator !== undefined) {\n      return new NumberValue(realm, realm.mathRandomGenerator());\n    } else if (realm.useAbstractInterpretation) {\n      return realm.deriveAbstract(\n        new TypesDomain(NumberValue),\n        ValuesDomain.topVal,\n        [],\n        buildMathRandom(realm.preludeGenerator),\n        { isPure: true, skipInvariant: true }\n      );\n    } else {\n      return new NumberValue(realm, Math.random());\n    }\n  });\n\n  return obj;\n}\n"]}